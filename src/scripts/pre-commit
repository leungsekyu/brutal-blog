#!/bin/bash

# 重定向到 stderr 的函数
log() {
    echo "$1" >&2
}

log "脚本开始执行..."

# 获取当前日期并格式化
currentDate=$(date +"%Y-%m-%d %H:%M")
log "当前时间: $currentDate"

# 获取所有暂存区中的 md 文件
staged_files=$(git diff --cached --name-only | grep "^src/content/blog/.*\.md$")

for file in $staged_files; do
    log "正在处理文件: $file"
    
    # 检查是否存在 publishedAt，如果不存在则添加
    if ! grep -q "publishedAt:" "$file"; then
        log "未找到 publishedAt 字段，将在 title 后添加"
        sed -i '' '/^title:/a\
publishedAt: '"$currentDate"'\
' "$file"
        log "已添加 publishedAt 字段"
    else
        # 只有当存在 publishedAt 时才处理 updatedAt
        if grep -q "updatedAt:" "$file"; then
            sed -i '' "s/updatedAt: .*/updatedAt: $currentDate/" "$file"
            log "已更新现有的 updatedAt 字段"
        else
            log "未找到 updatedAt 字段，将在 publishedAt 后添加"
            sed -i '' '/^publishedAt:/a\
updatedAt: '"$currentDate"'\
' "$file"
            log "已添加 updatedAt 字段"
        fi
    fi

    # 将更新后的文件添加回暂存区
    git add "$file"
    log "已将 $file 添加回暂存区"
done

log "脚本执行完成"